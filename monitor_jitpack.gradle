// æŒç»­ç›‘æ§ JitPack æ„å»ºçŠ¶æ€çš„è„šæœ¬
// ä½¿ç”¨æ–¹æ³•: ./gradlew -b monitor_jitpack.gradle monitorBuild

plugins {
    id 'java'
}

repositories {
    maven { url "https://jitpack.io" }
    mavenCentral()
    mavenLocal()
}

configurations {
    testDeps
}

dependencies {
    // æµ‹è¯• burialTimer è¿œç¨‹ä¾èµ–
    testDeps 'com.github.zhiying94:burialTimer:2.0.5'
    
    // æµ‹è¯•æ’ä»¶ç±»è·¯å¾„
    testDeps 'com.github.zhiying94:burial-plugin:2.0.12'
}

task monitorBuild {
    doLast {
        println "ğŸ”„ å¼€å§‹æŒç»­ç›‘æ§ JitPack æ„å»ºçŠ¶æ€..."
        println "ğŸ“¦ ç›‘æ§ç‰ˆæœ¬: burialTimer:2.0.5, burial-plugin:2.0.12"
        println "â° æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤šç­‰å¾… 10 åˆ†é’Ÿ"
        println ""
        
        int maxAttempts = 20  // 10 åˆ†é’Ÿ (20 * 30 ç§’)
        int attempt = 0
        boolean success = false
        
        while (attempt < maxAttempts && !success) {
            attempt++
            println "ğŸ” ç¬¬ ${attempt} æ¬¡æ£€æŸ¥ (${new Date().format('HH:mm:ss')})..."
            
            try {
                // å°è¯•è§£æä¾èµ–
                def artifacts = configurations.testDeps.resolvedConfiguration.resolvedArtifacts
                
                if (artifacts.size() >= 2) {
                    println "âœ… JitPack æ„å»ºæˆåŠŸï¼"
                    println "ğŸ“‹ æˆåŠŸè§£æçš„ä¾èµ–ï¼š"
                    artifacts.each { artifact ->
                        println "   - ${artifact.moduleVersion.id.group}:${artifact.moduleVersion.id.name}:${artifact.moduleVersion.id.version}"
                    }
                    success = true
                    break
                } else {
                    println "âš ï¸  éƒ¨åˆ†ä¾èµ–è§£ææˆåŠŸï¼Œç»§ç»­ç­‰å¾…..."
                }
                
            } catch (Exception e) {
                println "âŒ æ„å»ºæœªå®Œæˆ: ${e.message.contains('401') ? '401 Unauthorized - æ„å»ºä¸­' : e.message}"
                
                if (attempt < maxAttempts) {
                    println "â³ ç­‰å¾… 30 ç§’åé‡è¯•..."
                    Thread.sleep(30000)  // ç­‰å¾… 30 ç§’
                }
            }
        }
        
        if (!success) {
            println ""
            println "âŒ è¶…æ—¶ï¼šæ„å»ºå¯èƒ½å¤±è´¥æˆ–éœ€è¦æ›´é•¿æ—¶é—´"
            println "ğŸ”— è¯·æ‰‹åŠ¨æ£€æŸ¥: https://jitpack.io/com/github/zhiying94/burialPlugin"
            throw new GradleException("JitPack æ„å»ºè¶…æ—¶")
        } else {
            println ""
            println "ğŸ‰ JitPack æ„å»ºéªŒè¯æˆåŠŸï¼å¯ä»¥ä½¿ç”¨è¿œç¨‹ä¾èµ–äº†ï¼"
        }
    }
}

task quickCheck {
    doLast {
        println "ğŸ” å¿«é€Ÿæ£€æŸ¥ JitPack æ„å»ºçŠ¶æ€..."
        
        try {
            def artifacts = configurations.testDeps.resolvedConfiguration.resolvedArtifacts
            println "âœ… æ„å»ºæˆåŠŸï¼è§£æåˆ° ${artifacts.size()} ä¸ªä¾èµ–ï¼š"
            artifacts.each { artifact ->
                println "   - ${artifact.moduleVersion.id.group}:${artifact.moduleVersion.id.name}:${artifact.moduleVersion.id.version}"
            }
        } catch (Exception e) {
            println "âŒ æ„å»ºæœªå®Œæˆ: ${e.message.contains('401') ? '401 Unauthorized - è¿˜åœ¨æ„å»ºä¸­' : e.message}"
            println "ğŸ’¡ è¿è¡Œ './gradlew -b monitor_jitpack.gradle monitorBuild' è¿›è¡ŒæŒç»­ç›‘æ§"
        }
    }
}
